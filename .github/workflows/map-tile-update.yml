name: Generate OSRS Map Tiles

on:
  schedule:
    - cron: '0 0,3,6,9,12,15,18,21 * * *' # Every 3 hours starting at 00:00 UTC
  workflow_dispatch:

jobs:
  generate-tiles:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      packages: read

    steps:
      - name: Free up disk space
        run: |
          echo "Initial disk usage:"
          df -h
          sudo rm -rf /opt/hostedtoolcache/go
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          echo "After cleanup:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image from ghcr.io
        id: pull
        run: |
          IMAGE_LOWER=$(echo "${{ github.repository }}/map-tile-generator" | tr '[:upper:]' '[:lower:]')
          docker pull ghcr.io/${IMAGE_LOWER}:latest
          echo "image=ghcr.io/${IMAGE_LOWER}:latest" >> $GITHUB_OUTPUT

      - name: Run tile generator in Docker
        run: |
          docker run -v "${{ github.workspace }}:/repo" ${{ steps.pull.outputs.image }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit changes
        run: |
          git add .
          git diff-index --quiet HEAD || git commit -m "Automated tile generation $(date -u +'%Y-%m-%d %H:%M:%S')"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: auto/map-tile-update
          title: "Automated Tile Update"
          commit-message: "Update map tiles"
          body: "This PR contains automatically generated tile updates."
          delete-branch: true

      - name: Create disk usage report
        if: always()
        run: |
           du -BM /home/runner/work 2>/dev/null | awk '$1+0 >= 1' | sort -nr > disk-usage.txt || true
        continue-on-error: true

      - name: Upload disk usage report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: disk-usage
          path: disk-usage.txt

